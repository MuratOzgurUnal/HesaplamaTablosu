<div id="ceyrek-ortalama-hesaplayici" class="calculator-container" style="justify-content: center;">
    <div class="calculator-column" style="flex: 0 1 600px;">
        <h3>Hesaplama Bilgileri</h3>
        <form id="ceyrek-ortalama-form" onsubmit="return false;">
            <div class="form-group">
                <label for="nokta-bakiye">Nokta Bakiye (TL)</label>
                <input type="text" id="nokta-bakiye" inputmode="numeric" placeholder="Örn: 7.000.000" required>
            </div>
            <div class="form-group">
                <label for="aylik-ortalama">Aylık Ortalama Gerçekleşen (TL)</label>
                <input type="text" id="aylik-ortalama" inputmode="numeric" placeholder="Örn: 8.000.000" required>
            </div>
            <div class="form-group">
                <label for="butce">Bütçe (TL)</label>
                <input type="text" id="butce" inputmode="numeric" placeholder="Örn: 10.000.000" required>
            </div>
            <div class="button-group" style="justify-content: center;">
                <button type="button" id="hesapla-btn" class="btn btn-primary"><i class="fa-solid fa-calculator"></i> Hesapla</button>
            </div>
        </form>
        
        <!-- Sonuç Alanı -->
        <div id="result-container" class="hidden" style="margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius); text-align: center; background-color: #f8f9fa;">
            <p style="margin: 0; font-size: 1.1rem; color: var(--secondary-color);">Çeyreklik ortalama hedefine ulaşmak için gereken tutar:</p>
            <p id="sonuc-tutari" style="font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-top: 0.5rem;">0,00 TL</p>
            <p id="bilgi-metni" style="font-size: 0.9rem; color: var(--secondary-color); margin-top: 1rem; border-top: 1px solid var(--light-gray); padding-top: 1rem;"></p>
        </div>
    </div>
</div>

<script>
    (() => {
        const container = document.getElementById('ceyrek-ortalama-hesaplayici');
        if (!container) return;

        const hesaplaBtn = container.querySelector('#hesapla-btn');
        const noktaBakiyeInput = container.querySelector('#nokta-bakiye');
        const aylikOrtalamaInput = container.querySelector('#aylik-ortalama');
        const butceInput = container.querySelector('#butce');
        const resultContainer = container.querySelector('#result-container');
        const sonucTutariP = container.querySelector('#sonuc-tutari');
        const bilgiMetniP = container.querySelector('#bilgi-metni');

        // Yardımcı fonksiyonlar
        const formatCurrency = (value) => value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
        const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '').replace(',', '.'));
        const formatNumberInput = (input) => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value ? new Intl.NumberFormat('tr-TR').format(value) : '';
            });
        };

        // Girdi alanlarına otomatik sayı formatlamayı uygula
        formatNumberInput(noktaBakiyeInput);
        formatNumberInput(aylikOrtalamaInput);
        formatNumberInput(butceInput);

        hesaplaBtn.addEventListener('click', () => {
            const noktaBakiye = parseFormattedNumber(noktaBakiyeInput.value);
            const aylikOrtalamaGerceklesen = parseFormattedNumber(aylikOrtalamaInput.value);
            const butce = parseFormattedNumber(butceInput.value);

            if (isNaN(noktaBakiye) || isNaN(aylikOrtalamaGerceklesen) || isNaN(butce)) {
                alert("Lütfen tüm alanlara geçerli sayılar giriniz.");
                return;
            }

            // --- Tarih Bilgilerini Otomatik Belirle ---
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11 arası

            // Mevcut çeyreği bul (0, 1, 2, 3)
            const quarterIndex = Math.floor(currentMonth / 3);
            
            // Çeyreğin başlangıç ve bitiş aylarını belirle
            const quarterStartMonth = quarterIndex * 3;
            
            const quarterStartDate = new Date(currentYear, quarterStartMonth, 1);
            const quarterEndDate = new Date(currentYear, quarterStartMonth + 3, 0);

            // Milisaniyeyi güne çeviren yardımcı fonksiyon
            const msToDays = (ms) => ms / (1000 * 60 * 60 * 24);

            const totalDaysInQuarter = msToDays(quarterEndDate - quarterStartDate) + 1;
            const currentDayOfQuarter = Math.floor(msToDays(today - quarterStartDate)) + 1;
            const remainingDaysInQuarter = totalDaysInQuarter - currentDayOfQuarter;

            // --- Hesaplama ---
            let sonuc = 0;

            if (remainingDaysInQuarter <= 0) {
                sonucTutariP.textContent = "Hesaplama Yapılamaz";
                bilgiMetniP.textContent = "Mevcut çeyrek sona ermiştir.";
            } else {
                const budgetPart = butce * totalDaysInQuarter;
                const realizedPart = aylikOrtalamaGerceklesen * currentDayOfQuarter;
                
                const numerator = budgetPart - realizedPart;
                const resultBeforeSpot = numerator / remainingDaysInQuarter;
                
                sonuc = resultBeforeSpot - noktaBakiye;

                // Bilgilendirme metnini oluştur
                bilgiMetniP.innerHTML = `
                    Mevcut Çeyrek: <strong>${quarterIndex + 1}. Çeyrek</strong> <br>
                    Çeyrekteki Toplam Gün: <strong>${totalDaysInQuarter}</strong> | 
                    Geçen Gün: <strong>${currentDayOfQuarter}</strong> | 
                    Kalan Gün: <strong>${remainingDaysInQuarter}</strong>
                `;
            }

            // Sonucu göster
            sonucTutariP.textContent = formatCurrency(sonuc);
            resultContainer.classList.remove('hidden');
        });
    })();
</script>